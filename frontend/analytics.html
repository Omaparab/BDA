<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - Fraud Detection</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f5f7fa; color: #2d3748; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        header { background: white; padding: 24px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 24px; }
        h1 { font-size: 28px; font-weight: 600; }
        h2 { font-size: 20px; font-weight: 600; margin-bottom: 16px; }
        h3 { font-size: 18px; font-weight: 600; margin-bottom: 12px; color: #4a5568; }
        .grid { display: grid; gap: 20px; margin-bottom: 24px; }
        .two-col { grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); }
        .card { background: white; padding: 24px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .label { font-size: 14px; color: #718096; margin-bottom: 8px; }
        .value { font-size: 32px; font-weight: 600; }
        nav { background: white; padding: 16px 24px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 24px; display: flex; align-items: center; justify-content: space-between; }
        nav .logo { font-size: 20px; font-weight: 600; color: #2d3748; }
        nav .nav-links { display: flex; gap: 24px; align-items: center; }
        nav a { color: #4a5568; text-decoration: none; font-weight: 500; transition: color 0.2s; }
        nav a:hover { color: #4299e1; }
        nav a.active { color: #4299e1; font-weight: 600; }
        .chart-container { position: relative; height: 400px; margin-top: 20px; }
        .confusion-matrix { display: grid; grid-template-columns: auto 1fr 1fr; gap: 2px; max-width: 400px; margin: 20px auto; }
        .cm-cell { padding: 20px; text-align: center; font-weight: 600; border-radius: 4px; }
        .cm-label { padding: 20px; display: flex; align-items: center; justify-content: center; font-weight: 600; color: #4a5568; }
        .cm-tp { background: #c6f6d5; color: #22543d; }
        .cm-fp { background: #fed7d7; color: #742a2a; }
        .cm-fn { background: #fed7d7; color: #742a2a; }
        .cm-tn { background: #c6f6d5; color: #22543d; }
        .metric-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-top: 20px; }
        .metric-card { background: #f7fafc; padding: 16px; border-radius: 6px; text-align: center; }
        .metric-value { font-size: 24px; font-weight: 600; color: #2d3748; }
        .metric-label { font-size: 12px; color: #718096; margin-top: 4px; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: #4a5568; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 14px; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #4299e1; }
        .btn { padding: 12px 24px; background: #4299e1; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .btn:hover { background: #3182ce; }
        .btn:disabled { background: #cbd5e0; cursor: not-allowed; }
        .prediction-result { margin-top: 20px; padding: 20px; border-radius: 8px; font-weight: 600; text-align: center; }
        .result-fraud { background: #fed7d7; color: #742a2a; }
        .result-legit { background: #c6f6d5; color: #22543d; }
        .feature-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 12px; margin-top: 16px; }
        .feature-item { background: #f7fafc; padding: 12px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; }
        .feature-name { font-weight: 500; color: #4a5568; }
        .feature-count { font-weight: 600; color: #4299e1; }
        .loading { text-align: center; padding: 40px; color: #718096; }
        .info-box { background: #ebf8ff; border-left: 4px solid #4299e1; padding: 16px; border-radius: 4px; margin-bottom: 20px; }
        .info-box p { color: #2c5282; margin: 4px 0; }
    </style>
</head>
<body>
    <div class="container">
        <nav>
            <div class="logo">SafePay</div>
            <div class="nav-links">
                <a href="/">Dashboard</a>
                <a href="/analytics" class="active">Analytics</a>
            </div>
        </nav>

        <header>
            <h1>Advanced Analytics</h1>
            <p style="color: #718096; margin-top: 8px;">Machine Learning Insights & Predictions</p>
        </header>

        <!-- Confusion Matrix Section -->
        <div class="card">
            <h2>Model Performance - Confusion Matrix</h2>
            <div class="info-box">
                <p><strong>Model:</strong> Random Forest Classifier with 80-20 train-test split</p>
                <p><strong>Features:</strong> All available transaction features (normalized)</p>
            </div>
            <div id="confusion-loading" class="loading">Loading confusion matrix...</div>
            <div id="confusion-content" style="display: none;">
                <div class="confusion-matrix">
                    <div></div>
                    <div class="cm-label"><strong>Predicted Legit</strong></div>
                    <div class="cm-label"><strong>Predicted Fraud</strong></div>
                    
                    <div class="cm-label"><strong>Actual Legit</strong></div>
                    <div class="cm-cell cm-tn" id="tn">0</div>
                    <div class="cm-cell cm-fp" id="fp">0</div>
                    
                    <div class="cm-label"><strong>Actual Fraud</strong></div>
                    <div class="cm-cell cm-fn" id="fn">0</div>
                    <div class="cm-cell cm-tp" id="tp">0</div>
                </div>

                <div class="metric-grid">
                    <div class="metric-card">
                        <div class="metric-value" id="accuracy">0%</div>
                        <div class="metric-label">Accuracy</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="precision">0%</div>
                        <div class="metric-label">Precision</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="recall">0%</div>
                        <div class="metric-label">Recall</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="f1score">0%</div>
                        <div class="metric-label">F1 Score</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Flajolet-Martin Algorithm Section -->
        <div class="card">
            <h2>Unique Categories Analysis</h2>
            <div class="info-box">
                <p><strong>Algorithm:</strong> Flajolet-Martin - Probabilistic counting for cardinality estimation</p>
                <p><strong>Purpose:</strong> Efficiently estimate unique values in large datasets with minimal memory</p>
            </div>
            <div id="fm-loading" class="loading">Analyzing unique categories...</div>
            <div id="fm-content" style="display: none;">
                <div class="feature-list" id="feature-list"></div>
            </div>
        </div>

        <!-- Prediction Section -->
        <div class="grid two-col">
            <div class="card">
                <h2>Fraud Prediction</h2>
                <p style="color: #718096; margin-bottom: 20px;">Enter transaction details to predict fraud probability</p>
                
                <form id="prediction-form">
                    <div id="input-fields"></div>
                    <button type="submit" class="btn" id="predict-btn">Predict Transaction</button>
                </form>

                <div id="prediction-result" style="display: none;"></div>
            </div>

            <div class="card">
                <h2>Feature Importance</h2>
                <div class="chart-container">
                    <canvas id="featureChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        let featureImportance = {};

        // Load Confusion Matrix
        fetch('/api/confusion-matrix')
            .then(r => r.json())
            .then(data => {
                document.getElementById('confusion-loading').style.display = 'none';
                document.getElementById('confusion-content').style.display = 'block';
                
                document.getElementById('tn').textContent = data.confusion_matrix.tn.toLocaleString();
                document.getElementById('fp').textContent = data.confusion_matrix.fp.toLocaleString();
                document.getElementById('fn').textContent = data.confusion_matrix.fn.toLocaleString();
                document.getElementById('tp').textContent = data.confusion_matrix.tp.toLocaleString();
                
                document.getElementById('accuracy').textContent = data.metrics.accuracy + '%';
                document.getElementById('precision').textContent = data.metrics.precision + '%';
                document.getElementById('recall').textContent = data.metrics.recall + '%';
                document.getElementById('f1score').textContent = data.metrics.f1_score + '%';

                featureImportance = data.feature_importance;
                renderFeatureImportance();
            })
            .catch(e => {
                document.getElementById('confusion-loading').textContent = 'Error loading confusion matrix';
            });

        // Load Flajolet-Martin Results
        fetch('/api/flajolet-martin')
            .then(r => r.json())
            .then(data => {
                document.getElementById('fm-loading').style.display = 'none';
                document.getElementById('fm-content').style.display = 'block';
                
                const featureList = document.getElementById('feature-list');
                featureList.innerHTML = Object.entries(data.unique_counts)
                    .sort((a, b) => b[1] - a[1])
                    .map(([feature, count]) => `
                        <div class="feature-item">
                            <span class="feature-name">${feature.replace(/_/g, ' ')}</span>
                            <span class="feature-count">${count.toLocaleString()} unique</span>
                        </div>
                    `).join('');
            })
            .catch(e => {
                document.getElementById('fm-loading').textContent = 'Error analyzing categories';
            });

        // Load Prediction Form Fields
        fetch('/api/model-features')
            .then(r => r.json())
            .then(data => {
                const inputFields = document.getElementById('input-fields');
                inputFields.innerHTML = data.features.map(feature => `
                    <div class="form-group">
                        <label for="${feature}">${feature.replace(/_/g, ' ')}</label>
                        <input type="number" id="${feature}" name="${feature}" step="any" required>
                    </div>
                `).join('');
            });

        // Handle Prediction Form
        document.getElementById('prediction-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const btn = document.getElementById('predict-btn');
            btn.disabled = true;
            btn.textContent = 'Predicting...';
            
            const formData = new FormData(e.target);
            const data = {};
            formData.forEach((value, key) => data[key] = parseFloat(value));
            
            try {
                const response = await fetch('/api/predict', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                const resultDiv = document.getElementById('prediction-result');
                resultDiv.style.display = 'block';
                
                if (result.prediction === 1) {
                    resultDiv.className = 'prediction-result result-fraud';
                    resultDiv.innerHTML = `
                        <div style="font-size: 48px; margin-bottom: 10px;">⚠️</div>
                        <div style="font-size: 24px;">FRAUDULENT TRANSACTION</div>
                        <div style="margin-top: 10px; font-size: 16px;">Confidence: ${result.probability}%</div>
                    `;
                } else {
                    resultDiv.className = 'prediction-result result-legit';
                    resultDiv.innerHTML = `
                        <div style="font-size: 48px; margin-bottom: 10px;">✓</div>
                        <div style="font-size: 24px;">LEGITIMATE TRANSACTION</div>
                        <div style="margin-top: 10px; font-size: 16px;">Confidence: ${result.probability}%</div>
                    `;
                }
            } catch (error) {
                const resultDiv = document.getElementById('prediction-result');
                resultDiv.style.display = 'block';
                resultDiv.className = 'prediction-result';
                resultDiv.style.background = '#fed7d7';
                resultDiv.innerHTML = `<div>Error making prediction. Please try again.</div>`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'Predict Transaction';
            }
        });

        function renderFeatureImportance() {
            if (Object.keys(featureImportance).length === 0) return;
            
            const sorted = Object.entries(featureImportance)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            const ctx = document.getElementById('featureChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(([name, _]) => name.replace(/_/g, ' ')),
                    datasets: [{
                        label: 'Feature Importance',
                        data: sorted.map(([_, importance]) => importance),
                        backgroundColor: '#4299e1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: { display: true, text: 'Importance Score' }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>