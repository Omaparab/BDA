<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - Fraud Detection</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f5f7fa; color: #2d3748; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        header { background: white; padding: 24px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 24px; }
        h1 { font-size: 28px; font-weight: 600; }
        h2 { font-size: 20px; font-weight: 600; margin-bottom: 16px; }
        h3 { font-size: 18px; font-weight: 600; margin-bottom: 12px; color: #4a5568; }
        .grid { display: grid; gap: 20px; margin-bottom: 24px; }
        .two-col { grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); }
        .card { background: white; padding: 24px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        nav { background: white; padding: 16px 24px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 24px; display: flex; align-items: center; justify-content: space-between; }
        nav .logo { font-size: 20px; font-weight: 600; color: #2d3748; }
        nav .nav-links { display: flex; gap: 24px; align-items: center; }
        nav a { color: #4a5568; text-decoration: none; font-weight: 500; transition: color 0.2s; }
        nav a:hover { color: #4299e1; }
        nav a.active { color: #4299e1; font-weight: 600; }
        .chart-container { position: relative; height: 350px; margin-top: 20px; }
        .confusion-matrix { display: grid; grid-template-columns: auto 1fr 1fr; gap: 2px; max-width: 400px; margin: 20px auto; }
        .cm-cell { padding: 20px; text-align: center; font-weight: 600; border-radius: 4px; }
        .cm-label { padding: 20px; display: flex; align-items: center; justify-content: center; font-weight: 600; color: #4a5568; }
        .cm-tp { background: #c6f6d5; color: #22543d; }
        .cm-fp { background: #fed7d7; color: #742a2a; }
        .cm-fn { background: #fed7d7; color: #742a2a; }
        .cm-tn { background: #c6f6d5; color: #22543d; }
        .metric-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-top: 20px; }
        .metric-card { background: #f7fafc; padding: 16px; border-radius: 6px; text-align: center; }
        .metric-value { font-size: 24px; font-weight: 600; color: #2d3748; }
        .metric-label { font-size: 12px; color: #718096; margin-top: 4px; }
        .loading { text-align: center; padding: 40px; color: #718096; }
        .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #4299e1; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .info-box { background: #ebf8ff; border-left: 4px solid #4299e1; padding: 16px; border-radius: 4px; margin-bottom: 20px; }
        .info-box p { color: #2c5282; margin: 4px 0; line-height: 1.5; }
        .algorithm-result { background: #f7fafc; padding: 16px; border-radius: 6px; margin-top: 12px; }
        .stat-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e2e8f0; }
        .stat-label { color: #4a5568; font-weight: 500; }
        .stat-value { color: #2d3748; font-weight: 600; }
        .error-box { background: #fed7d7; border-left: 4px solid #e53e3e; padding: 16px; border-radius: 4px; color: #742a2a; }
        .success-badge { background: #c6f6d5; color: #22543d; padding: 4px 12px; border-radius: 12px; font-size: 14px; font-weight: 600; display: inline-block; }
    </style>
</head>
<body>
    <div class="container">
        <nav>
            <div class="logo">üîí SafePay</div>
            <div class="nav-links">
                <a href="/">Dashboard</a>
                <a href="/analytics" class="active">Analytics</a>
                <a href="/add-transaction">Add Transaction</a>
            </div>
        </nav>

        <header>
            <h1>üìä Advanced Analytics Dashboard</h1>
            <p style="color: #718096; margin-top: 8px;">XGBoost Machine Learning Model Performance & Stream Mining Analysis</p>
        </header>

        <div id="main-loading" class="loading">
            <div class="loading-spinner"></div>
            <p>Loading analytics data...</p>
        </div>

        <div id="error-container" style="display: none;"></div>

        <div id="analytics-content" style="display: none;">
            <!-- Model Performance Section -->
            <div class="card">
                <h2>üéØ Model Performance - XGBoost Classifier</h2>
                <div class="info-box">
                    <p><strong>üöÄ Algorithm:</strong> XGBoost (Extreme Gradient Boosting) with SMOTE for class balancing</p>
                    <p><strong>üìà Training:</strong> 80-20 train-test split with stratification | 300 trees | Learning rate: 0.05</p>
                    <p><strong>‚öôÔ∏è Features:</strong> Encoded categorical + temporal features with StandardScaler normalization</p>
                    <p><strong>üéì Regularization:</strong> L1 (0.1) + L2 (1.0) + Early stopping to prevent overfitting</p>
                </div>
                
                <div class="confusion-matrix">
                    <div></div>
                    <div class="cm-label"><strong>Predicted Legit</strong></div>
                    <div class="cm-label"><strong>Predicted Fraud</strong></div>
                    
                    <div class="cm-label"><strong>Actual Legit</strong></div>
                    <div class="cm-cell cm-tn" id="tn">-</div>
                    <div class="cm-cell cm-fp" id="fp">-</div>
                    
                    <div class="cm-label"><strong>Actual Fraud</strong></div>
                    <div class="cm-cell cm-fn" id="fn">-</div>
                    <div class="cm-cell cm-tp" id="tp">-</div>
                </div>

                <div class="metric-grid">
                    <div class="metric-card">
                        <div class="metric-value" id="accuracy">-%</div>
                        <div class="metric-label">Accuracy</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="precision">-%</div>
                        <div class="metric-label">Precision</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="recall">-%</div>
                        <div class="metric-label">Recall</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="f1score">-%</div>
                        <div class="metric-label">F1 Score</div>
                    </div>
                </div>

                <div id="performance-status" style="margin-top: 20px; text-align: center;"></div>
            </div>

            <!-- Stream Mining Algorithms -->
            <div class="grid two-col">
                <!-- DGIM Algorithm -->
                <div class="card">
                    <h2>üìà DGIM Algorithm</h2>
                    <div class="info-box">
                        <p><strong>Purpose:</strong> Real-time monitoring of risky transactions in sliding windows</p>
                        <p><strong>Method:</strong> Datar-Gionis-Indyk-Motwani algorithm for counting 1s in data streams</p>
                        <p><strong>Application:</strong> Detects sudden spikes in high-value or suspicious transactions</p>
                        <p><strong>Complexity:</strong> O(log¬≤N) memory vs O(N) for exact counting</p>
                    </div>
                    <div id="dgim-content" class="algorithm-result">
                        <p style="color: #718096; text-align: center;">Loading DGIM results...</p>
                    </div>
                </div>

                <!-- Bloom Filter -->
                <div class="card">
                    <h2>üîç Bloom Filter</h2>
                    <div class="info-box">
                        <p><strong>Purpose:</strong> Fast blacklist checking with minimal memory</p>
                        <p><strong>Method:</strong> Probabilistic data structure for set membership testing</p>
                        <p><strong>Application:</strong> First-line defense to filter known fraudulent patterns</p>
                        <p><strong>Properties:</strong> No false negatives, possible false positives</p>
                    </div>
                    <div id="bloom-content" class="algorithm-result">
                        <p style="color: #718096; text-align: center;">Loading Bloom Filter results...</p>
                    </div>
                </div>
            </div>

            <!-- Feature Importance -->
            <div class="card">
                <h2>‚≠ê Feature Importance Analysis</h2>
                <p style="color: #718096; margin-bottom: 20px;">Top 10 most influential features in fraud detection (XGBoost importance scores)</p>
                <div class="chart-container">
                    <canvas id="featureChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        console.log('Loading analytics data...');
        
        // Load all analytics data in one call
        fetch('/api/analytics-data')
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Analytics data received:', data);
                
                document.getElementById('main-loading').style.display = 'none';
                document.getElementById('analytics-content').style.display = 'block';
                
                // Check if data has error
                if (data.error) {
                    showError('Model not trained or error occurred: ' + data.error);
                    return;
                }
                
                // Confusion Matrix
                if (data.confusion_matrix) {
                    document.getElementById('tn').textContent = data.confusion_matrix.tn.toLocaleString();
                    document.getElementById('fp').textContent = data.confusion_matrix.fp.toLocaleString();
                    document.getElementById('fn').textContent = data.confusion_matrix.fn.toLocaleString();
                    document.getElementById('tp').textContent = data.confusion_matrix.tp.toLocaleString();
                } else {
                    console.error('No confusion matrix data');
                }
                
                // Metrics
                if (data.metrics) {
                    document.getElementById('accuracy').textContent = data.metrics.accuracy + '%';
                    document.getElementById('precision').textContent = data.metrics.precision + '%';
                    document.getElementById('recall').textContent = data.metrics.recall + '%';
                    document.getElementById('f1score').textContent = data.metrics.f1_score + '%';
                    
                    // Performance status
                    const accuracy = data.metrics.accuracy;
                    const f1 = data.metrics.f1_score;
                    let statusHTML = '';
                    
                    if (accuracy >= 80 && f1 >= 80) {
                        statusHTML = `
                            <div style="background: #c6f6d5; padding: 16px; border-radius: 6px; border-left: 4px solid #48bb78;">
                                <div style="font-size: 18px; font-weight: 600; color: #22543d; margin-bottom: 8px;">
                                    ‚úÖ EXCELLENT PERFORMANCE
                                </div>
                                <div style="color: #276749;">
                                    Model achieves >80% on both Accuracy (${accuracy}%) and F1 Score (${f1}%)
                                </div>
                            </div>
                        `;
                    } else if (accuracy >= 80 || f1 >= 80) {
                        statusHTML = `
                            <div style="background: #feebc8; padding: 16px; border-radius: 6px; border-left: 4px solid #ed8936;">
                                <div style="font-size: 18px; font-weight: 600; color: #7c2d12; margin-bottom: 8px;">
                                    ‚úì GOOD PERFORMANCE
                                </div>
                                <div style="color: #9c4221;">
                                    Model achieves >80% on at least one key metric
                                </div>
                            </div>
                        `;
                    } else {
                        statusHTML = `
                            <div style="background: #fed7d7; padding: 16px; border-radius: 6px; border-left: 4px solid #e53e3e;">
                                <div style="font-size: 18px; font-weight: 600; color: #742a2a; margin-bottom: 8px;">
                                    ‚ö†Ô∏è NEEDS IMPROVEMENT
                                </div>
                                <div style="color: #9b2c2c;">
                                    Model performance below 80% threshold. Consider more data or feature engineering.
                                </div>
                            </div>
                        `;
                    }
                    
                    document.getElementById('performance-status').innerHTML = statusHTML;
                } else {
                    console.error('No metrics data');
                }

                // DGIM Results
                if (data.dgim && !data.dgim.error) {
                    const dgim = data.dgim;
                    document.getElementById('dgim-content').innerHTML = `
                        <div class="stat-row">
                            <span class="stat-label">üìä Window Size</span>
                            <span class="stat-value">${dgim.window_size.toLocaleString()} transactions</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">üî¢ Estimated Risky Count</span>
                            <span class="stat-value">${dgim.estimated_risky_count.toLocaleString()}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">‚úÖ Actual Risky Count</span>
                            <span class="stat-value">${dgim.actual_risky_count.toLocaleString()}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">üéØ Estimation Accuracy</span>
                            <span class="stat-value" style="color: ${dgim.accuracy >= 90 ? '#48bb78' : '#ed8936'};">${dgim.accuracy}%</span>
                        </div>
                        <div style="margin-top: 16px; padding: 12px; background: white; border-radius: 4px;">
                            <p style="color: #718096; font-size: 14px; line-height: 1.6;">${dgim.description}</p>
                        </div>
                    `;
                } else {
                    document.getElementById('dgim-content').innerHTML = `
                        <div class="error-box">
                            <p><strong>Error loading DGIM results:</strong> ${data.dgim?.error || 'Unknown error'}</p>
                        </div>
                    `;
                }

                // Bloom Filter Results
                if (data.bloom_filter && !data.bloom_filter.error) {
                    const bf = data.bloom_filter;
                    document.getElementById('bloom-content').innerHTML = `
                        <div class="stat-row">
                            <span class="stat-label">üîê Fraud Patterns Stored</span>
                            <span class="stat-value">${bf.fraud_patterns_stored.toLocaleString()}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">üíæ Filter Size (bits)</span>
                            <span class="stat-value">${bf.filter_size.toLocaleString()}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">üî® Hash Functions</span>
                            <span class="stat-value">${bf.hash_functions}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">‚ö†Ô∏è False Positive Rate</span>
                            <span class="stat-value" style="color: ${bf.false_positive_rate < 5 ? '#48bb78' : '#ed8936'};">${bf.false_positive_rate}%</span>
                        </div>
                        <div style="margin-top: 12px; padding: 12px; background: white; border-radius: 4px;">
                            <div style="font-weight: 600; margin-bottom: 8px; color: #4a5568;">üìä Test Results:</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 14px;">
                                <div>‚úÖ True Positives: <strong>${bf.test_results.true_positives}</strong></div>
                                <div>‚úÖ True Negatives: <strong>${bf.test_results.true_negatives}</strong></div>
                                <div>‚ö†Ô∏è False Positives: <strong>${bf.test_results.false_positives}</strong></div>
                                <div>‚ö†Ô∏è False Negatives: <strong>${bf.test_results.false_negatives}</strong></div>
                            </div>
                        </div>
                        <div style="margin-top: 16px; padding: 12px; background: white; border-radius: 4px;">
                            <p style="color: #718096; font-size: 14px; line-height: 1.6;">${bf.description}</p>
                        </div>
                    `;
                } else {
                    document.getElementById('bloom-content').innerHTML = `
                        <div class="error-box">
                            <p><strong>Error loading Bloom Filter results:</strong> ${data.bloom_filter?.error || 'Unknown error'}</p>
                        </div>
                    `;
                }

                // Feature Importance Chart
                if (data.feature_importance && Object.keys(data.feature_importance).length > 0) {
                    renderFeatureImportance(data.feature_importance);
                } else {
                    console.error('No feature importance data');
                    document.querySelector('.chart-container').innerHTML = `
                        <p style="text-align: center; color: #718096;">No feature importance data available</p>
                    `;
                }
            })
            .catch(error => {
                console.error('Error loading analytics:', error);
                document.getElementById('main-loading').style.display = 'none';
                showError('Failed to load analytics data: ' + error.message + 
                         '<br><br>Please ensure:<br>‚Ä¢ MongoDB is running<br>‚Ä¢ Model is trained<br>‚Ä¢ Data exists in the database');
            });

        function showError(message) {
            document.getElementById('error-container').innerHTML = `
                <div class="card">
                    <div class="error-box">
                        <h3 style="margin-bottom: 12px;">‚ùå Error Loading Analytics</h3>
                        <p>${message}</p>
                        <button onclick="location.reload()" style="margin-top: 16px; padding: 10px 20px; background: #e53e3e; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            üîÑ Retry
                        </button>
                    </div>
                </div>
            `;
            document.getElementById('error-container').style.display = 'block';
        }

        function renderFeatureImportance(featureImportance) {
            const sorted = Object.entries(featureImportance)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            if (sorted.length === 0) {
                document.querySelector('.chart-container').innerHTML = `
                    <p style="text-align: center; color: #718096;">No feature importance data available</p>
                `;
                return;
            }
            
            const ctx = document.getElementById('featureChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(([name, _]) => name.replace(/_/g, ' ')),
                    datasets: [{
                        label: 'Importance Score',
                        data: sorted.map(([_, importance]) => importance),
                        backgroundColor: '#4299e1',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Importance: ' + context.parsed.x.toFixed(4);
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: { display: true, text: 'Importance Score' }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>