<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - Fraud Detection</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f5f7fa; color: #2d3748; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        header { background: white; padding: 24px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 24px; }
        h1 { font-size: 28px; font-weight: 600; }
        h2 { font-size: 20px; font-weight: 600; margin-bottom: 16px; }
        h3 { font-size: 18px; font-weight: 600; margin-bottom: 12px; color: #4a5568; }
        .grid { display: grid; gap: 20px; margin-bottom: 24px; }
        .two-col { grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); }
        .card { background: white; padding: 24px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        nav { background: white; padding: 16px 24px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 24px; display: flex; align-items: center; justify-content: space-between; }
        nav .logo { font-size: 20px; font-weight: 600; color: #2d3748; }
        nav .nav-links { display: flex; gap: 24px; align-items: center; }
        nav a { color: #4a5568; text-decoration: none; font-weight: 500; transition: color 0.2s; }
        nav a:hover { color: #4299e1; }
        nav a.active { color: #4299e1; font-weight: 600; }
        .chart-container { position: relative; height: 350px; margin-top: 20px; }
        .confusion-matrix { display: grid; grid-template-columns: auto 1fr 1fr; gap: 2px; max-width: 400px; margin: 20px auto; }
        .cm-cell { padding: 20px; text-align: center; font-weight: 600; border-radius: 4px; }
        .cm-label { padding: 20px; display: flex; align-items: center; justify-content: center; font-weight: 600; color: #4a5568; }
        .cm-tp { background: #c6f6d5; color: #22543d; }
        .cm-fp { background: #fed7d7; color: #742a2a; }
        .cm-fn { background: #fed7d7; color: #742a2a; }
        .cm-tn { background: #c6f6d5; color: #22543d; }
        .metric-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-top: 20px; }
        .metric-card { background: #f7fafc; padding: 16px; border-radius: 6px; text-align: center; }
        .metric-value { font-size: 24px; font-weight: 600; color: #2d3748; }
        .metric-label { font-size: 12px; color: #718096; margin-top: 4px; }
        .loading { text-align: center; padding: 40px; color: #718096; }
        .info-box { background: #ebf8ff; border-left: 4px solid #4299e1; padding: 16px; border-radius: 4px; margin-bottom: 20px; }
        .info-box p { color: #2c5282; margin: 4px 0; line-height: 1.5; }
        .algorithm-result { background: #f7fafc; padding: 16px; border-radius: 6px; margin-top: 12px; }
        .stat-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e2e8f0; }
        .stat-label { color: #4a5568; font-weight: 500; }
        .stat-value { color: #2d3748; font-weight: 600; }
        .community-card { background: white; border: 2px solid #e2e8f0; padding: 16px; border-radius: 6px; margin-bottom: 12px; }
        .risk-high { border-left: 4px solid #e53e3e; }
        .risk-medium { border-left: 4px solid #ed8936; }
        .risk-low { border-left: 4px solid #48bb78; }
        .badge { display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; }
        .badge-high { background: #fed7d7; color: #742a2a; }
        .badge-medium { background: #feebc8; color: #7c2d12; }
        .badge-low { background: #c6f6d5; color: #22543d; }
    </style>
</head>
<body>
    <div class="container">
        <nav>
            <div class="logo">üîê SafePay</div>
            <div class="nav-links">
                <a href="/">Dashboard</a>
                <a href="/analytics" class="active">Analytics</a>
                <a href="/add-transaction">Add Transaction</a>
            </div>
        </nav>

        <header>
            <h1>üìä Advanced Analytics Dashboard</h1>
            <p style="color: #718096; margin-top: 8px;">Analysis for Fraud Detection</p>
        </header>

        <div id="main-loading" class="loading">Loading analytics data...</div>

        <div id="analytics-content" style="display: none;">
            <!-- Model Performance Section -->
            <div class="card">
                <h2>üéØ Model Performance - Random Forest Classifier</h2>
                <div class="info-box">
                    <p><strong>Algorithm:</strong> Random Forest with balanced class weights and optimized hyperparameters</p>
                    <p><strong>Training:</strong> 80-20 train-test split with stratification for imbalanced data</p>
                    <p><strong>Features:</strong> All numeric transaction features with StandardScaler normalization</p>
                </div>
                
                <div class="confusion-matrix">
                    <div></div>
                    <div class="cm-label"><strong>Predicted Legit</strong></div>
                    <div class="cm-label"><strong>Predicted Fraud</strong></div>
                    
                    <div class="cm-label"><strong>Actual Legit</strong></div>
                    <div class="cm-cell cm-tn" id="tn">0</div>
                    <div class="cm-cell cm-fp" id="fp">0</div>
                    
                    <div class="cm-label"><strong>Actual Fraud</strong></div>
                    <div class="cm-cell cm-fn" id="fn">0</div>
                    <div class="cm-cell cm-tp" id="tp">0</div>
                </div>

                <div class="metric-grid">
                    <div class="metric-card">
                        <div class="metric-value" id="accuracy">0%</div>
                        <div class="metric-label">Accuracy</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="precision">0%</div>
                        <div class="metric-label">Precision</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="recall">0%</div>
                        <div class="metric-label">Recall</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="f1score">0%</div>
                        <div class="metric-label">F1 Score</div>
                    </div>
                </div>
            </div>

            <!-- Stream Mining Algorithms -->
            <div class="grid two-col">
                <!-- DGIM Algorithm -->
                <div class="card">
                    <h2>üìà DGIM Algorithm</h2>
                    <div class="info-box">
                        <p><strong>Purpose:</strong> Real-time monitoring of risky transactions in sliding windows</p>
                        <p><strong>Method:</strong> Datar-Gionis-Indyk-Motwani algorithm for counting 1s in data streams</p>
                        <p><strong>Application:</strong> Detects sudden spikes in high-value or suspicious transactions</p>
                    </div>
                    <div id="dgim-content" class="algorithm-result"></div>
                </div>

                <!-- Bloom Filter -->
                <div class="card">
                    <h2>üîç Bloom Filter</h2>
                    <div class="info-box">
                        <p><strong>Purpose:</strong> Fast blacklist checking with minimal memory</p>
                        <p><strong>Method:</strong> Probabilistic data structure for set membership testing</p>
                        <p><strong>Application:</strong> First-line defense to filter known fraudulent patterns</p>
                    </div>
                    <div id="bloom-content" class="algorithm-result"></div>
                </div>
            </div>

            

            <!-- Feature Importance -->
            <div class="card">
                <h2>‚≠ê Feature Importance Analysis</h2>
                <p style="color: #718096; margin-bottom: 20px;">Top 10 most influential features in fraud detection</p>
                <div class="chart-container">
                    <canvas id="featureChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Load all analytics data in one call
        fetch('/api/analytics-data')
            .then(r => r.json())
            .then(data => {
                document.getElementById('main-loading').style.display = 'none';
                document.getElementById('analytics-content').style.display = 'block';
                
                // Confusion Matrix
                document.getElementById('tn').textContent = data.confusion_matrix.tn.toLocaleString();
                document.getElementById('fp').textContent = data.confusion_matrix.fp.toLocaleString();
                document.getElementById('fn').textContent = data.confusion_matrix.fn.toLocaleString();
                document.getElementById('tp').textContent = data.confusion_matrix.tp.toLocaleString();
                
                document.getElementById('accuracy').textContent = data.metrics.accuracy + '%';
                document.getElementById('precision').textContent = data.metrics.precision + '%';
                document.getElementById('recall').textContent = data.metrics.recall + '%';
                document.getElementById('f1score').textContent = data.metrics.f1_score + '%';

                // DGIM Results
                if (data.dgim && !data.dgim.error) {
                    document.getElementById('dgim-content').innerHTML = `
                        <div class="stat-row">
                            <span class="stat-label">Window Size</span>
                            <span class="stat-value">${data.dgim.window_size.toLocaleString()} transactions</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Estimated Risky Count</span>
                            <span class="stat-value">${data.dgim.estimated_risky_count.toLocaleString()}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Actual Risky Count</span>
                            <span class="stat-value">${data.dgim.actual_risky_count.toLocaleString()}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Estimation Accuracy</span>
                            <span class="stat-value" style="color: #48bb78;">${data.dgim.accuracy}%</span>
                        </div>
                        <p style="color: #718096; margin-top: 12px; font-size: 14px;">${data.dgim.description}</p>
                    `;
                }

                // Bloom Filter Results
                if (data.bloom_filter && !data.bloom_filter.error) {
                    const bf = data.bloom_filter;
                    document.getElementById('bloom-content').innerHTML = `
                        <div class="stat-row">
                            <span class="stat-label">Fraud Patterns Stored</span>
                            <span class="stat-value">${bf.fraud_patterns_stored.toLocaleString()}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Filter Size (bits)</span>
                            <span class="stat-value">${bf.filter_size.toLocaleString()}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Hash Functions</span>
                            <span class="stat-value">${bf.hash_functions}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">False Positive Rate</span>
                            <span class="stat-value" style="color: ${bf.false_positive_rate < 5 ? '#48bb78' : '#ed8936'};">${bf.false_positive_rate}%</span>
                        </div>
                        <div style="margin-top: 12px; padding: 12px; background: white; border-radius: 4px;">
                            <div style="font-weight: 600; margin-bottom: 8px;">Test Results:</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 14px;">
                                <div>‚úì True Positives: ${bf.test_results.true_positives}</div>
                                <div>‚úì True Negatives: ${bf.test_results.true_negatives}</div>
                                <div>‚ö†Ô∏è False Positives: ${bf.test_results.false_positives}</div>
                                <div>‚ö†Ô∏è False Negatives: ${bf.test_results.false_negatives}</div>
                            </div>
                        </div>
                        <p style="color: #718096; margin-top: 12px; font-size: 14px;">${bf.description}</p>
                    `;
                }

                

                // Feature Importance Chart
                if (data.feature_importance) {
                    renderFeatureImportance(data.feature_importance);
                }
            })
            .catch(e => {
                document.getElementById('main-loading').innerHTML = `
                    <div style="color: #e53e3e;">‚ùå Error loading analytics data</div>
                    <div style="color: #718096; margin-top: 8px;">Please ensure the model is trained and try refreshing the page</div>
                `;
            });

        function renderFeatureImportance(featureImportance) {
            const sorted = Object.entries(featureImportance)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            const ctx = document.getElementById('featureChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(([name, _]) => name.replace(/_/g, ' ')),
                    datasets: [{
                        label: 'Importance Score',
                        data: sorted.map(([_, importance]) => importance),
                        backgroundColor: '#4299e1',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Importance: ' + context.parsed.x.toFixed(4);
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: { display: true, text: 'Importance Score' }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>